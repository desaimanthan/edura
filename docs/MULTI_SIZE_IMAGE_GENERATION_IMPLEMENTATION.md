# Multi-Size Image Generation Implementation

## Overview

This implementation adds automatic multi-size image generation to the Image Generation Agent, allowing it to create and store images in three sizes (Large, Medium, Small) while supporting different image types (cover, slide, etc.).

## Key Features

### 1. **Multi-Size Generation**
- **Large (L)**: 1536x1024 - Original size generated by OpenAI gpt-image-1
- **Medium (M)**: 768x512 - 50% scale, backend processed
- **Small (S)**: 384x256 - 25% scale, backend processed

### 2. **Configurable Image Types**
- **Cover Images**: `courses/{course_id}/images/cover/{size}/filename.png`
- **Slide Images**: `courses/{course_id}/images/slide/{size}/filename.png`
- **Extensible**: Easy to add new image types (thumbnail, banner, etc.)

### 3. **Processing Flow**
1. **LLM Generation**: OpenAI gpt-image-1 generates original L size (1536x1024)
2. **Backend Processing**: PIL/Pillow resizes to M and S sizes
3. **Multi-Upload**: All 3 sizes uploaded to R2 storage simultaneously
4. **Metadata**: Comprehensive metadata tracking for each size

## Implementation Details

### Enhanced R2 Storage Service

#### New Generic Methods
```python
# Generic multi-size upload
async def upload_images_multi_size(
    course_id: str, 
    large_image: bytes, 
    medium_image: bytes, 
    small_image: bytes,
    filename: str, 
    image_type: str = "cover",  # Configurable type
    content_type: str = "image/png"
) -> Dict[str, Any]

# Generic image retrieval by size and type
async def get_image_by_size(
    course_id: str, 
    filename: str, 
    image_type: str, 
    size: str
) -> Optional[bytes]

# Generic listing by size and type
async def list_images_by_size(
    course_id: str, 
    image_type: str
) -> Dict[str, List[Dict[str, Any]]]

# Generic deletion for all sizes
async def delete_images_all_sizes(
    course_id: str, 
    filename: str, 
    image_type: str
) -> Dict[str, bool]
```

#### Storage Structure
```
courses/
├── {course_id}/
    ├── images/
        ├── cover/
        │   ├── large/cover_image.png
        │   ├── medium/cover_image.png
        │   └── small/cover_image.png
        └── slide/
            ├── large/slide_1.png
            ├── medium/slide_1.png
            └── small/slide_1.png
```

### Enhanced Image Generation Agent

#### New Generic Method
```python
async def generate_image_multi_size(
    course_id: str, 
    image_name: str,
    image_description: str = "", 
    image_type: str = "cover",      # Configurable type
    filename: str = "image",        # Configurable filename
    style_preference: str = "professional_educational",
    dynamic_colors: bool = True
) -> Dict[str, Any]
```

#### Image Processing Methods
```python
def _resize_image(
    image_bytes: bytes, 
    target_size: Tuple[int, int], 
    quality: int = 85
) -> bytes

def _generate_multiple_sizes(
    original_image_bytes: bytes
) -> Dict[str, bytes]
```

### Backward Compatibility

The implementation maintains full backward compatibility:
- Existing `generate_course_cover_image()` method unchanged
- Existing `upload_course_cover_image()` method unchanged
- New methods use existing methods internally where appropriate

## Usage Examples

### 1. Cover Image Generation (Multi-Size)
```python
result = await image_agent.generate_course_cover_image_multi_size(
    course_id="course_123",
    course_name="Machine Learning Fundamentals",
    course_description="Learn ML basics...",
    style_preference="professional_educational",
    dynamic_colors=True
)
```

### 2. Slide Image Generation (Multi-Size)
```python
result = await image_agent.generate_image_multi_size(
    course_id="course_123",
    image_name="Introduction to Neural Networks",
    image_description="Overview of neural network concepts",
    image_type="slide",
    filename="slide_1",
    style_preference="tech_focused"
)
```

### 3. Custom Image Type
```python
result = await image_agent.generate_image_multi_size(
    course_id="course_123",
    image_name="Course Thumbnail",
    image_type="thumbnail",
    filename="thumb_main"
)
```

## Response Format

```json
{
  "success": true,
  "images": {
    "large": {
      "r2_key": "courses/123/images/cover/large/cover_image.png",
      "public_url": "https://cdn.example.com/courses/123/images/cover/large/cover_image.png",
      "size": "1536x1024",
      "file_size": 245760,
      "generated_from": "openai_gpt_image_1"
    },
    "medium": {
      "r2_key": "courses/123/images/cover/medium/cover_image.png",
      "public_url": "https://cdn.example.com/courses/123/images/cover/medium/cover_image.png",
      "size": "768x512",
      "file_size": 61440,
      "generated_from": "backend_processing"
    },
    "small": {
      "r2_key": "courses/123/images/cover/small/cover_image.png",
      "public_url": "https://cdn.example.com/courses/123/images/cover/small/cover_image.png",
      "size": "384x256",
      "file_size": 15360,
      "generated_from": "backend_processing"
    }
  },
  "total_sizes": 3,
  "image_type": "cover",
  "image_metadata": {
    "original_size": "1536x1024",
    "quality": "medium",
    "format": "png",
    "total_file_size": 322560,
    "generated_with": "gpt-image-1",
    "processing_method": "llm_original_backend_resize",
    "created_at": "2025-01-17T14:30:00.000Z",
    "style_preference": "professional_educational",
    "sizes_generated": ["large", "medium", "small"],
    "image_type": "cover"
  }
}
```

## Benefits

### 1. **Performance Optimization**
- Frontend can load appropriate size based on context
- Reduced bandwidth usage for mobile/thumbnail views
- Faster page load times

### 2. **Storage Efficiency**
- Optimized compression for each size
- Smart fallback system (if resize fails, uses original)
- Atomic uploads (all succeed or all fail)

### 3. **Flexibility**
- Supports any image type (cover, slide, thumbnail, etc.)
- Configurable filenames and storage paths
- Easy to extend for new use cases

### 4. **Cost Efficiency**
- Only 1 API call to OpenAI instead of 3
- Backend processing is much faster and cheaper
- Consistent quality across all sizes

## Technical Considerations

### Dependencies
- Added `Pillow>=10.0.0` to requirements.txt for image processing

### Image Quality
- Uses LANCZOS resampling for high-quality resizing
- Maintains PNG transparency and optimization
- Configurable JPEG quality (default: 90 for resized images)

### Error Handling
- Graceful fallback if resize operations fail
- Partial success handling (some sizes succeed, others fail)
- Comprehensive error reporting

### Metadata Tracking
- Tracks generation method for each size
- Records processing timestamps
- Maintains file size and dimension information

## Usage for Slides Agent

The slides agent can now easily generate slide images:

```python
# In slides_agent.py
async def generate_slide_image(self, course_id: str, slide_title: str, slide_content: str):
    return await self.image_agent.generate_image_multi_size(
        course_id=course_id,
        image_name=slide_title,
        image_description=slide_content,
        image_type="slide",  # Will store in courses/{id}/images/slide/
        filename=f"slide_{slide_number}",
        style_preference="professional_educational"
    )
```

This creates a flexible, efficient, and scalable image generation system that can be used across all agents while maintaining backward compatibility.
